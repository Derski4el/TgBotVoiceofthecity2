{% extends "base.html" %}

{% block title %}Voice of the City Admin - –¢–æ—á–∫–∏{% endblock %}

{% block content %}
    <h2>–°–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫</h2>

    <!-- Simple Search Form -->
    <div class="filter-card">
        <h3>–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç–æ—á–∫–∏</h3>
        <form method="get" action="/bookings" class="simple-search-form">
            <div class="search-row">
                <div class="search-group">
                    <input type="text" id="search" name="search" value="{{ search }}"
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –∞–¥—Ä–µ—Å —Ç–æ—á–∫–∏...">
                </div>
                <div class="search-actions">
                    <button type="submit" class="btn btn-primary">–ù–∞–π—Ç–∏</button>
                    <a href="/bookings" class="btn btn-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
                </div>
            </div>
        </form>
    </div>

    <!-- Results Summary -->
    <div class="results-summary">
        {% if search %}
            <p>–ù–∞–π–¥–µ–Ω–æ <strong>{{ filtered_locations }}</strong> –∏–∑ <strong>{{ total_locations }}</strong> —Ç–æ—á–µ–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É "{{ search }}"</p>
            <p>–í—Å–µ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ç–æ—á–∫–∞—Ö: <strong>{{ filtered_bookings }}</strong></p>
        {% else %}
            <p>–í—Å–µ–≥–æ —Ç–æ—á–µ–∫: <strong>{{ total_locations }}</strong></p>
            <p>–í—Å–µ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π: <strong>{{ total_bookings }}</strong></p>
        {% endif %}
    </div>

    {% if locations_data %}
        {% for location in locations_data %}
            <div class="booking-card">
                <div class="booking-header">
                    <h3 class="booking-title">üìç {{ location.address }}</h3>
                    <div class="booking-id">
                        ID: {{ location.id }}
                        <a href="/locations/{{ location.id }}/edit" class="btn-edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—á–∫—É</a>
                    </div>
                </div>

                {% if location.bookings %}
                    <h4>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–∞ ({{ location.bookings|length }}):</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                                    <th>–§–ò–û</th>
                                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                    <th>Email</th>
                                    <th>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for booking in location.bookings %}
                                    <tr>
                                        <td>{{ booking.date }} {{ booking.time }}</td>
                                        <td>
                                            {% if booking.musician %}
                                                {{ booking.musician.name }}
                                            {% else %}
                                                –ù–µ —É–∫–∞–∑–∞–Ω–æ
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if booking.musician %}
                                                {{ booking.musician.phone }}
                                            {% else %}
                                                –ù–µ —É–∫–∞–∑–∞–Ω
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if booking.musician %}
                                                {{ booking.musician.email }}
                                            {% else %}
                                                –ù–µ —É–∫–∞–∑–∞–Ω
                                            {% endif %}
                                        </td>
                                        <td>{{ booking.duration }} —á–∞—Å{% if booking.duration == 2 %}–∞{% endif %}</td>
                                        <td>
                                            <div class="action-buttons">
                                                <a href="/bookings/{{ booking.id }}/edit" class="btn btn-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                                                <button onclick="deleteBooking('{{ booking.id }}', '{{ booking.date }} {{ booking.time }}')" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="no-bookings">
                        <p class="no-participants">üìÖ –ù–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω</p>
                        <p class="availability-note">–≠—Ç–∞ —Ç–æ—á–∫–∞ —Å–≤–æ–±–æ–¥–Ω–∞ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</p>
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <div class="card">
            <p>{% if search %}–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.{% else %}–¢–æ—á–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.{% endif %}</p>
        </div>
    {% endif %}

    <script>
        async function deleteBooking(bookingId, bookingTime) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ ${bookingTime}?`)) {
                return;
            }

            try {
                const response = await fetch(`/bookings/${bookingId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
            }
        }
    </script>
{% endblock %}
